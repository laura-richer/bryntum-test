<template>
    <header class="demo-header">
        <div id="title-container">
            <a
                id="title"
                :href="link"
            >
                <h1>{{ headerTitle }}</h1>
            </a>
        </div>
        <slot />
        <div id="tools">
            <bryntum-button
                text="Download Trial"
                :href="downloadLink"
                cls="b-green b-raised"
            />
            <bryntum-button
                ref="codeButtonRef"
                icon="b-icon-code"
                tooltip="Click to show the code viewer"
                cls="b-raised b-blue b-code-button"
                :hidden="hiddenEditor"
                @click="toggleCodeEditor"
            />
            <bryntum-button
                ref="downloadButtonRef"
                icon="b-icon-download"
                tooltip="Download this demo zip archive"
                cls="b-raised b-blue"
                href="#"
                :hidden="true"
            />
            <bryntum-fullscreen-button />
        </div>
    </header>
</template>

<script setup lang="ts">
import { computed, defineProps, onMounted, ref } from 'vue';
import BryntumFullscreenButton from './BryntumFullscreenButton.vue';
import BryntumButton from './BryntumButton.vue';
import { AjaxHelper, CSSHelper, DemoCodeEditor } from '@bryntum/calendar';

defineProps<{
    title?: string;
}>();

const codeButtonRef = ref<typeof BryntumButton | null>(null);

const downloadButtonRef = ref<typeof BryntumButton | null>(null);

const headerTitle = document.title.split(' - ')[1] || document.title;

const isTest = document.location.search.includes('test');

const demoProduct = document.location.href.match(/\/(\w+)(-trial)?\/[-\w]*examples\//)?.[1].toLowerCase() || 'calendar';

const downloadLink = `https://bryntum.com/download/?product=${demoProduct}`;

const appFolder = '../';

const hiddenEditor = !Boolean(DemoCodeEditor.monacoCodePath);

let codeEditor: DemoCodeEditor | undefined;

const link = computed(() => {
    const match = /(.*?\/)(examples.*?\/frameworks\/.*?)\/dist/.exec(document.location.href);
    return match
        ? `${match[1]}examples/#example-${match[2].replace(/\//gm, '-').replace('examples-frameworks', 'frameworks')}`
        : '#';
});

const toggleCodeEditor = async() => {
    codeEditor = await DemoCodeEditor.toggleCodeEditor(
        codeEditor,
        codeButtonRef.value!.instance.value,
        {
            appFolder,
            preferredSources : [
                /App\.vue/,
                /\w+Config\.[tj]s/
            ]
        }
    );
};

const initDownload = async() => {
    const appConfig = (await AjaxHelper.get(`${appFolder}app.config.json`, { parseJson : true })).parsedJson;
    if (appConfig.zip || isTest) {
        const downloadButton  = downloadButtonRef.value!.instance.value;
        downloadButton.hidden = false;
        downloadButton.href   = `${appFolder}${appConfig.zip}`;
    }
};

onMounted(() => {
    if (!hiddenEditor) {
        CSSHelper.insertRule('body { flex-direction : row !important }');
        CSSHelper.insertRule('#__nuxt, #container, #app { flex : 1 !important; overflow : hidden !important }');
        CSSHelper.insertRule('.b-codeeditor-header { padding : 0.5em !important }');
        initDownload();
    }
});

defineExpose({
    link,
    headerTitle,
    hiddenEditor,
    downloadLink,
    toggleCodeEditor
});

</script>
